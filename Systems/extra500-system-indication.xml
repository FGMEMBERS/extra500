<?xml version="1.0" encoding="utf-8" ?>
	
<!--
    This file is part of extra500

    The extra500 is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    (at your option) any later version.

    The extra500 is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with extra500.  If not, see <http://www.gnu.org/licenses/>.

      Author: Eric van den Berg
      Date: 2013-05-23

      Last change:      Eric van den Berg
      Date:             2013-06-09
-->

<system name="indication">

	<channel name="engineparameters">
<!-- ENGINE -->

<!-- setting motoring property: starter on, but cutoff also on (no fuel,no ignition)	-->
		<switch name="motoring">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/engines/engine[0]/cutoff eq 1
				/controls/engines/engine[0]/starter eq 1
			</test>
			<output>aircraft/engine/motoring</output>
		</switch>

		<switch name="spoolup">
			<default value="0"/>
			<test logic="AND" value="1">
				/engines/engine[0]/n1 gt aircraft/engine/N1-old
				/controls/engines/engine[0]/cutoff eq 0
				propulsion/engine/set-running eq 0
			</test>
			<output>aircraft/engine/spooling-up</output>
		</switch>

		<switch name="spooldown">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/engines/engine[0]/starter eq 0
				propulsion/engine/set-running eq 0
				/engines/engine[0]/n1 gt 0.1
				/engines/engine[0]/n1 lt aircraft/engine/N1-old
			</test>
			<output>aircraft/engine/spooling-down</output>
		</switch>

		<fcs_function name="aircraft/engine/N1-old">
    			<function>
       			<description>old N1 for next cycle</description>
       				<property>/engines/engine[0]/n1</property>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/fuelflow-3rd">
    			<function>
       			<description>engine fuel flow 3rd order coeff</description>
       				<table>
            				<independentVar lookup="row">atmosphere/pressure-altitude</independentVar>
            				<tableData>
						0	-0.000000020936
						1000	-0.000000020531
						2000	-0.00000001985
						3000	-0.00000001881
						4000	-0.000000017304
						5000	-0.000000015193
						6000	-0.000000015796
						7000	-0.000000016411
						8000	-0.00000001703
						9000	-0.000000017642
						10000	-0.000000018234
						11000	-0.000000019072
						12000	-0.00000001996
						13000	-0.0000000209
						14000	-0.000000021895
						15000	-0.000000022951
						16000	-0.000000023698
						17000	-0.000000024371
						18000	-0.000000024921
						19000	-0.000000025278
						20000	-0.000000025339
						21000	-0.000000033397
						22000	-0.000000043542
						23000	-0.000000056406
						24000	-0.000000072851
						25000	-0.00000009407
            				</tableData>
      				</table>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/fuelflow-2rd">
    			<function>
       			<description>engine fuel flow 2rd order coeff</description>
       				<table>
            				<independentVar lookup="row">atmosphere/pressure-altitude</independentVar>
            				<tableData>
						0	0.000022627
						1000	0.000022051
						2000	0.000021249
						3000	0.000020164
						4000	0.000018722
						5000	0.000016826
						6000	0.000017211
						7000	0.000017597
						8000	0.00001798
						9000	0.000018353
						10000	0.000018709
						11000	0.000019171
						12000	0.000019649
						13000	0.000020144
						14000	0.000020655
						15000	0.000021184
						16000	0.000021608
						17000	0.000021995
						18000	0.000022327
						19000	0.000022576
						20000	0.000022701
						21000	0.000026872
						22000	0.000031912
						23000	0.000038051
						24000	0.0000456
						25000	0.000054978
            				</tableData>
      				</table>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/fuelflow-1rd">
    			<function>
       			<description>engine fuel flow 1rd order coeff</description>
       				<table>
            				<independentVar lookup="row">atmosphere/pressure-altitude</independentVar>
            				<tableData>
						0	-0.0085847
						1000	-0.0083227
						2000	-0.0080015
						3000	-0.0076079
						4000	-0.0071253
						5000	-0.0065325
						6000	-0.0065536
						7000	-0.0065716
						8000	-0.0065855
						9000	-0.006594
						10000	-0.0065955
						11000	-0.0066122
						12000	-0.0066278
						13000	-0.006642
						14000	-0.0066545
						15000	-0.0066651
						16000	-0.00667
						17000	-0.006666
						18000	-0.0066503
						19000	-0.0066188
						20000	-0.0065663
						21000	-0.0071751
						22000	-0.0078919
						23000	-0.0087432
						24000	-0.0097637
						25000	-0.0109996
            				</tableData>
      				</table>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/fuelflow-0rd">
    			<function>
       			<description>engine fuel flow 0rd order coeff</description>
       				<table>
            				<independentVar lookup="row">atmosphere/pressure-altitude</independentVar>
            				<tableData>
						0	1.7807
						1000	1.7364
						2000	1.6872
						3000	1.6322
						4000	1.5701
						5000	1.4995
						6000	1.4821
						7000	1.4644
						8000	1.4462
						9000	1.4276
						10000	1.4083
						11000	1.3913
						12000	1.374
						13000	1.3566
						14000	1.3389
						15000	1.321
						16000	1.3052
						17000	1.2889
						18000	1.272
						19000	1.2542
						20000	1.2353
						21000	1.2526
						22000	1.274
						23000	1.3005
						24000	1.3334
						25000	1.37423
            				</tableData>
      				</table>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/FF-lbs_h">
    			<function>
      			<description>fuel flow in pounds per hour</description>
			<product>
				<property>propulsion/engine/power-hp</property>   
				<sum>
					<product>
						<property>aircraft/engine/fuelflow-3rd</property>
						<property>propulsion/engine/power-hp</property>   
						<property>propulsion/engine/power-hp</property>   
						<property>propulsion/engine/power-hp</property>   
					</product>
					<product>
						<property>aircraft/engine/fuelflow-2rd</property>
						<property>propulsion/engine/power-hp</property>   
						<property>propulsion/engine/power-hp</property>   
					</product>
					<product>
						<property>aircraft/engine/fuelflow-1rd</property>
						<property>propulsion/engine/power-hp</property>   
					</product>
					<property>aircraft/engine/fuelflow-0rd</property>
				</sum>
			</product>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/TRQ-perc">
    			<function>
      			<description>Indicated TRQ in percent</description>
			<product>
				<property>/extra500/instrumentation/EIP/state</property>   <!--to make sure pointer is at 0 when unit is off -->
				<max>
					<value>0</value>			<!-- preventing TRQ below 0 -->
					<product>
						<property>propulsion/engine/power-hp</property>
						<value>493.797</value>
						<pow>
							<max>			<!-- preventing devision by 0 -->
								<property>propulsion/engine/propeller-rpm</property>
								<value>10</value>
							</max>
							<value>-1</value>
						</pow>
					</product>
				</max>
			</product>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/TOTr-degC">
    			<function>
       			<description>Indicated TOT when eng running</description>
       				<table>
            				<independentVar lookup="row">atmosphere/rho-slugs_ft3</independentVar>
            				<independentVar lookup="column">aircraft/engine/TRQ-perc</independentVar>
            				<tableData>
				0	20	40	60	80	90	100	120	140
		0.00097016	590	650	710	800	915	985	1020	1140	1250
		0.0014552	580	605	620	680	775	810	880	980	1080
		0.0019403	576	595	605	630	655	700	745	835	925
		0.0025224	550	570	590	600	605	610	640	710	795
            				</tableData>
      				</table>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/Delta-TOTsd-degC">
    			<function>
       			<description>TOT change when spooling down</description>
				<product>
					<property>aircraft/engine/dt-indication</property>
					<value>0.00015</value>
					<pow>
						<max>
							<value>0.1</value>
							<property>propulsion/engine/n1</property>
						</max>
						<value>2</value>
					</pow>
					<sum>
						<property>aircraft/engine/TOT-target-degC</property>
						<product>
							<value>-1</value>
							<property>aircraft/engine/OT-true-degC</property>
						</product>
					</sum>
				</product>
    			</function>
		</fcs_function>

<!--OIL TEMP -->
		<fcs_function name="aircraft/engine/Delta-OT-degC">
    			<function>
       			<description>Oil temp change</description>
	 			<product>
					<!--property>aircraft/engine/dt-indication</property-->
					<property>sim-dt-sec</property>
					<table>
            					<independentVar lookup="row">propulsion/engine/power-hp</independentVar>
            					<independentVar lookup="column">aircraft/engine/OT-true-degC</independentVar> 	<!-- to simulate the thermostat in the oil cooler-->
            					<tableData>
				-54		50		60		70	76	82
			0	-0.01		-0.01		-0.015		-0.02	-0.02	-0.02
			35	1.242		1.242		0.9		0.2	0.05	0
			380	1.8417		1.8417		0.6		0.3	0.07	0
			458	2.0707		2.0707		1.0		0.5	0.08	0
            					</tableData>
      					</table>
				</product>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/OT-true1-degC">
    			<function>
       			<description>Oil temperature before filter</description>
				<max>
					<property>atmosphere/T-degC</property>
					<sum>
						<property>aircraft/engine/OT-true-degC</property>
						<property>aircraft/engine/Delta-OT-degC</property>
					</sum>
				</max>
    			</function>
		</fcs_function>

		<switch name="OTinit">
			<default value="0"/>
			<test value="aircraft/engine/OT-true1-degC">
				simulation/sim-time-sec gt 1
			</test>
			<output>aircraft/engine/OT-true-degC</output>
		</switch>

		<fcs_function name="aircraft/engine/OT-target-degC">
    			<function>
       			<description>Oil temperature before filter</description>
	 			<product>
					<property>/extra500/instrumentation/EIP/state</property>		<!--to make sure pointer is at 0 when unit is off -->
					<property>aircraft/engine/OT-true-degC</property>
				</product>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/OP-psi">
    			<function>
       			<description>Indicated Oil Pressure</description>
				<product>
					<property>/extra500/instrumentation/EIP/state</property>   <!--to make sure pointer is at 0 when unit is off -->
	 				<sum>	
						<property>aircraft/engine/OP-maxsetting-psi</property>
						<value>-125</value>
       						<table>
            						<independentVar lookup="row">propulsion/engine/n1</independentVar>
							<independentVar lookup="column">aircraft/engine/OT-degC</independentVar>	<!-- oil pressure dependence on oil temperature-->
            						<tableData>
						0	25	82
					0	0	0	0
					12	0	0	0
					21	30	20	15
					26	63	46	40	
					42	135	123	48
					60	139	135	60
					70	143	140	100
					72.5	147	145	116
					75	149	147	119
					80	151	150	122
					90	154	153	124
					100	155	154	125
					110	156	155	125
            						</tableData>
      						</table>
					</sum>
				</product>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/n2">
   			 <function>
     			  <description>Indicated Oil Pressure</description>
				<product>
					<property>/extra500/instrumentation/EIP/state</property>   <!--to make sure pointer is at 0 when unit is off -->
					<property>propulsion/engine/propeller-rpm</property>
				</product>
    			</function>
		</fcs_function>

		<fcs_function name="aircraft/engine/FPtarget-psi">
   			 <function>
      			 <description>Indicated Fuel Pressure</description>
	 				<product>
						<max>	
							<property>aircraft/fuel/fuel-pump1</property>
							<property>aircraft/fuel/fuel-pump2</property>
						</max>
						<table>
            						<independentVar lookup="row">atmosphere/pressure-altitude</independentVar>
							<independentVar lookup="column">aircraft/engine/FT-degC</independentVar>	
            						<tableData>
						-18	0	38	
					-1000	22	21.5	21
					9000	21	21	20.5
					17500	21	20.5	20
					20100	20.5	20	19.5
					22000	20.5	19.5	19
					22500	20.5	19	18.5
					23100	20	18.5	18
					23500	19	18	17.5
					25000	18	16	15.5
            						</tableData>
      						</table>
					</product>
   			 </function>
		</fcs_function>

	</channel>

	<channel name="fuel pressure">
		<lag_filter name ="aircraft/engine/FP-psi">
 			<input>aircraft/engine/FPtarget-psi</input>
			<c1>1.0</c1>
		</lag_filter>
	</channel>

	<channel name="TOT">
		<lag_filter name ="aircraft/engine/TOT-degC">
 			<input>aircraft/engine/TOT-target-degC</input>
			<c1>1.0</c1>
		</lag_filter>
	</channel>

	<channel name="OT">
		<lag_filter name ="aircraft/engine/OT-degC">
 			<input>aircraft/engine/OT-target-degC</input>
			<c1>1.0</c1>
		</lag_filter>
	</channel>

<!--AIRSPEED ANTI-CALIBRATION-->
	<channel name="airspeed">
		<fcs_function name="/instrumentation/airspeed-IFD-LH/indicated-airspeed-kt">
			<function>
       			<description>Calibrated to indicated airspeed</description>
       				<table>
            				<independentVar lookup="row">/instrumentation/airspeed-IFD-LH/indicated-speed-kt</independentVar>
            				<independentVar lookup="column">fcs/flap-aero-pos-deg</independentVar>
            				<tableData>
						0	15	30
					0	0	0	0
					55	58	54	51
					60	62.2	59	57.5
					70	72	69.5	68
					80	80.5	79.7	69
					90	90.1	89.8	89.5
					100	100	100	99
					110	109.5	110	108
					120	119	120	120
					130	128.5	130	130
					140	138	140	140
					210	208	210	210
					222	220	222	222
					260	258	260	260
            				</tableData>
      				</table>
    			</function>
		</fcs_function>

		<fcs_function name="/instrumentation/airspeed-IFD-RH/indicated-airspeed-kt">
			<function>
       			<description>Calibrated to indicated airspeed</description>
       				<table>
            				<independentVar lookup="row">/instrumentation/airspeed-IFD-RH/indicated-speed-kt</independentVar>
            				<independentVar lookup="column">fcs/flap-aero-pos-deg</independentVar>
            				<tableData>
						0	15	30
					0	0	0	0
					55	58	54	51
					60	62.2	59	57.5
					70	72	69.5	68
					80	80.5	79.7	69
					90	90.1	89.8	89.5
					100	100	100	99
					110	109.5	110	108
					120	119	120	120
					130	128.5	130	130
					140	138	140	140
					210	208	210	210
					222	220	222	222
					260	258	260	260
            				</tableData>
      				</table>
    			</function>
		</fcs_function>

		<fcs_function name="/instrumentation/airspeed-backup/indicated-airspeed-kt">
			<function>
       			<description>Calibrated to indicated airspeed</description>
       				<table>
            				<independentVar lookup="row">/instrumentation/airspeed-backup/indicated-speed-kt</independentVar>
            				<independentVar lookup="column">fcs/flap-aero-pos-deg</independentVar>
            				<tableData>
						0	15	30
					0	0	0	0
					55	58	54	51
					60	62.2	59	57.5
					70	72	69.5	68
					80	80.5	79.7	69
					90	90.1	89.8	89.5
					100	100	100	99
					110	109.5	110	108
					120	119	120	120
					130	128.5	130	130
					140	138	140	140
					210	208	210	210
					222	220	222	222
					260	258	260	260
            				</tableData>
      				</table>
    			</function>
		</fcs_function>
	</channel>

<!--*****************************************Vertical speed LH IFD*****************************************************************-->
	<channel name="verticalspeedLHIFD">

		<fcs_function name="/instrumentation/ivsi-IFD-LH/vs-unfiltered">
			<function>
				<product>
					<value>60.0</value>		
					<sum>
						<property>/instrumentation/altimeter-IFD-LH/pressure-alt-ft</property>
						<property>/instrumentation/ivsi-IFD-LH/alt-old</property>
					</sum>
					<pow>
						<max>
							<value>0.0001</value>	
							<property>sim-dt-sec</property>
						</max>
						<value>-1.0</value>	
					</pow>
				</product>
			</function>
		</fcs_function>

		<lead_lag_filter name="/instrumentation/ivsi-IFD-LH/indicated-speed-fpm">
			<input>/instrumentation/ivsi-IFD-LH/vs-unfiltered</input>
			<c1>/autopilot/altsensor/c1</c1>
			<c2>/autopilot/altsensor/c2</c2>
			<c3>/autopilot/altsensor/c3</c3>
			<c4>/autopilot/altsensor/c4</c4>
		</lead_lag_filter>

		<fcs_function name="/instrumentation/ivsi-IFD-LH/alt-old">
			<function>
				<product>
					<value>-1.0</value>				
					<property>/instrumentation/altimeter-IFD-LH/pressure-alt-ft</property>
				</product>	
			</function>
		</fcs_function>
	</channel>

<!--*****************************************Vertical speed RH IFD*****************************************************************-->
	<channel name="verticalspeedRHIFD">

		<fcs_function name="/instrumentation/ivsi-IFD-RH/vs-unfiltered">
			<function>
				<product>
					<value>60.0</value>		
					<sum>
						<property>/instrumentation/altimeter-IFD-RH/pressure-alt-ft</property>
						<property>/instrumentation/ivsi-IFD-RH/alt-old</property>
					</sum>
					<pow>
						<max>
							<value>0.0001</value>	
							<property>sim-dt-sec</property>
						</max>
						<value>-1.0</value>	
					</pow>
				</product>
			</function>
		</fcs_function>

		<lead_lag_filter name="/instrumentation/ivsi-IFD-RH/indicated-speed-fpm">
			<input>/instrumentation/ivsi-IFD-RH/vs-unfiltered</input>
			<c1>/autopilot/altsensor/c1</c1>
			<c2>/autopilot/altsensor/c2</c2>
			<c3>/autopilot/altsensor/c3</c3>
			<c4>/autopilot/altsensor/c4</c4>
		</lead_lag_filter>

		<fcs_function name="/instrumentation/ivsi-IFD-RH/alt-old">
			<function>
				<product>
					<value>-1.0</value>				
					<property>/instrumentation/altimeter-IFD-RH/pressure-alt-ft</property>
				</product>	
			</function>
		</fcs_function>
	</channel>

</system>



